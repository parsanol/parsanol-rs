# Release Workflow for Parsanol-rs
#
# This workflow handles:
# - Version bumping (manual selection or skip)
# - Building and testing
# - Publishing to crates.io
# - Creating GitHub releases with artifacts
#
# Usage:
#   1. Push to main: Runs release-plz to auto-create Release PR
#   2. Manual dispatch: Select version bump type and run
#   3. Tag push: Builds and publishes to crates.io
#
# Manual Version Bump Options:
#   - skip: Just build/test (no version change)
#   - major: Incompatible API changes (1.0.0 â†’ 2.0.0)
#   - minor: Backward-compatible features (1.0.0 â†’ 1.1.0)
#   - patch: Backward-compatible fixes (1.0.0 â†’ 1.0.1)
#   - pre-alpha: Pre-release alpha (1.0.0 â†’ 1.1.0-alpha.1)
#   - pre-beta: Pre-release beta
#   - pre-rc: Release candidate
#   - graduate: Remove pre-release suffix (1.0.0-alpha.1 â†’ 1.0.0)

name: Release

on:
  # Manual dispatch with version bump options
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        default: skip
        options:
          - skip
          - major
          - minor
          - patch
          - pre-alpha
          - pre-beta
          - pre-rc
          - graduate
        # Custom version overrides version_bump
      custom_version:
        description: 'Custom version (overrides version_bump) - e.g. 1.2.3 or 1.0.0-beta.1'
        required: false
        type: string
  # Run on tag push for releases
  push:
    tags:
      - 'v*'

# Required permissions
permissions:
  contents: write
  pull-requests: write
  id-token: write  # Required for trusted publishing to crates.io

env:
  CARGO_TERM_COLOR: always

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Version Bumping (conditional - can be skipped)
  # ============================================================================
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    # Run if: manual trigger with version_bump != 'skip'
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.version_bump != 'skip'
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      changelog_date: ${{ steps.version.outputs.changelog_date }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch all tags
        run: git fetch --tags origin

      - name: Get current version
        id: current
        run: |
          CURRENT=$(grep '^version =' Cargo.toml | head -1 | sed 's/.*"\([^"]*\)".*/\1/')
          echo "Current version: $CURRENT"
          echo "current=$CURRENT" >> $GITHUB_OUTPUT

      - name: Calculate new version
        id: version
        env:
          BUMP_TYPE: ${{ github.event.inputs.version_bump }}
          CUSTOM_VERSION: ${{ github.event.inputs.custom_version }}
          CURRENT_VERSION: ${{ steps.current.outputs.current }}
        run: |
          set -e

          # Get changelog date
          echo "changelog_date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT

          # If custom version provided, use it directly
          if [[ -n "$CUSTOM_VERSION" ]]; then
            echo "new_version=$CUSTOM_VERSION" >> $GITHUB_OUTPUT
            echo "Using custom version: $CUSTOM_VERSION"
            exit 0
          fi

          # Parse current version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Handle pre-release versions
          PRERELEASE=""
          if [[ "$PATCH" == *"-"* ]]; then
            PRERELEASE="${PATCH#*-}"
            PATCH="${PATCH%%-*}"
          fi

          # Calculate new version based on bump type
          case "$BUMP_TYPE" in
            "major")
              NEW_VERSION="$((MAJOR + 1)).0.0"
              ;;
            "minor")
              NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
              ;;
            "patch")
              if [[ -n "$PRERELEASE" ]]; then
                NEW_VERSION="$MAJOR.$MINOR.$PATCH"
              else
                NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
              fi
              ;;
            "pre-alpha")
              NEW_VERSION="$MAJOR.$((MINOR + 1)).0-alpha.1"
              ;;
            "pre-beta")
              NEW_VERSION="$MAJOR.$((MINOR + 1)).0-beta.1"
              ;;
            "pre-rc")
              NEW_VERSION="$MAJOR.$((MINOR + 1)).0-rc.1"
              ;;
            "graduate")
              NEW_VERSION="$MAJOR.$MINOR.$PATCH"
              ;;
            *)
              echo "Unknown bump type: $BUMP_TYPE"
              exit 1
              ;;
          esac

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Calculated new version: $NEW_VERSION"

      - name: Update version in Cargo.toml
        env:
          NEW_VERSION: ${{ steps.version.outputs.new_version }}
        run: |
          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" Cargo.toml
          echo "Updated version to $NEW_VERSION"

      - name: Update CHANGELOG.md
        env:
          NEW_VERSION: ${{ steps.version.outputs.new_version }}
          CHANGELOG_DATE: ${{ steps.version.outputs.changelog_date }}
        run: |
          if [[ -f "CHANGELOG.md" ]]; then
            sed -i "/^## /i \\
            ## [$NEW_VERSION] - $CHANGELOG_DATE\\
            \\
            ### Added\\
            - TBD\\
            \\
            ### Changed\\
            - TBD\\
            \\
            ### Fixed\\
            - TBD\\
            \\
            " CHANGELOG.md
          fi

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create version commit and tag
        env:
          NEW_VERSION: ${{ steps.version.outputs.new_version }}
        run: |
          git add -A
          git commit -m "chore: bump version to ${NEW_VERSION}" || echo "No changes to commit"
          git tag -a "v${NEW_VERSION}" -m "Release v${NEW_VERSION}"
          git push origin "v${NEW_VERSION}" || echo "Tag push skipped (may already exist)"

  # ============================================================================
  # Auto Release PR (conventional commits - runs on tag or manual)
  # ============================================================================
  release-pr:
    name: Create Release PR
    runs-on: ubuntu-latest
    # Run on tag push OR manual dispatch
    if: |
      startsWith(github.ref, 'refs/tags/') ||
      github.event_name == 'workflow_dispatch'
    concurrency:
      group: release-plz-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run release-plz
        if: github.event_name == 'push'
        uses: release-plz/action@v0.5
        with:
          command: release-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Build Native Libraries (for FFI) - Multi-platform, Multi-arch
  # ============================================================================
  build-native:
    name: Build Native (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    needs: bump-version
    # Only run on tag push (release)
    if: startsWith(github.ref, 'refs/tags/')
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-22.04
            artifact: linux-x64
          # Linux ARM64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-22.04-arm
            artifact: linux-arm64
          # macOS (Intel)
          - target: x86_64-apple-darwin
            os: macos-latest
            artifact: macos-x64
          # macOS (Apple Silicon)
          - target: aarch64-apple-darwin
            os: macos-latest
            artifact: macos-arm64
          # Windows x64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            artifact: windows-x64
          # Windows ARM64
          - target: aarch64-pc-windows-msvc
            os: windows-11-arm
            artifact: windows-arm64
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}
          cache-on-failure: true

      - name: Build release library
        run: cargo build --release --target ${{ matrix.target }} --no-default-features

      - name: Prepare artifact (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p artifacts
          cp target/${{ matrix.target }}/release/libparsanol.* artifacts/ || true
          cp target/${{ matrix.target }}/release/libparsanol.rlib artifacts/ || true

      - name: Prepare artifact (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir artifacts
          copy target\${{ matrix.target }}\release\parsanol.* artifacts\ || true
          copy target\${{ matrix.target }}\release\parsanol.lib artifacts\ || true
          copy target\${{ matrix.target }}\release\parsanol.dll artifacts\ || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: artifacts/
          retention-days: 30

  # ============================================================================
  # Build Documentation
  # ============================================================================
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    needs: bump-version
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Build documentation
        run: |
          cargo doc --no-deps --all-features
          cp -r target/doc docs

      - name: Create documentation archive
        run: tar -czf docs.tar.gz -C target doc

      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs.tar.gz
          retention-days: 30

  # ============================================================================
  # Package for crates.io
  # ============================================================================
  package:
    name: Package Crate
    runs-on: ubuntu-latest
    needs: bump-version
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Package crate
        run: |
          cargo package --no-verify
          mkdir -p crate-package
          cp target/package/*.crate crate-package/ || true

      - name: Upload crate package
        uses: actions/upload-artifact@v4
        with:
          name: crate-package
          path: crate-package/
          retention-days: 30

  # ============================================================================
  # Publish to crates.io (via release-plz with Trusted Publishing)
  # ============================================================================
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: [build-native, build-docs, package]
    if: startsWith(github.ref, 'refs/tags/')
    environment: crates.io
    permissions:
      id-token: write  # Trusted publishing
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Run release-plz
        uses: release-plz/action@v0.5
        with:
          command: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for crates.io index
        run: sleep 60

  # ============================================================================
  # Create GitHub Release with artifacts
  # ============================================================================
  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-native, build-docs, package, publish]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          # Copy native libraries
          cp -r artifacts/linux-x64 release-assets/ || true
          cp -r artifacts/linux-arm64 release-assets/ || true
          cp -r artifacts/macos-x64 release-assets/ || true
          cp -r artifacts/macos-arm64 release-assets/ || true
          cp -r artifacts/windows-x64 release-assets/ || true
          cp -r artifacts/windows-arm64 release-assets/ || true
          # Copy documentation
          cp artifacts/documentation/docs.tar.gz release-assets/ || true
          # Copy crate package
          cp artifacts/crate-package/*.crate release-assets/ || true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          draft: false
          generate_release_notes: true
          files: |
            release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Notify
  # ============================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [publish, github-release]
    if: always()
    steps:
      - name: Report status
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version Bump | ${{ needs.bump-version.result == 'success' && 'âœ…' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release PR | ${{ needs.release-pr.result == 'success' && 'âœ…' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Publish | ${{ needs.publish.result == 'success' && 'âœ…' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | ${{ needs.github-release.result == 'success' && 'âœ…' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.publish.result }}" == "success" ]]; then
            echo "ðŸ“¦ View on crates.io: https://crates.io/crates/parsanol" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“– View on docs.rs: https://docs.rs/parsanol" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.publish.result }}" == "failure" ]]; then
            exit 1
          fi
