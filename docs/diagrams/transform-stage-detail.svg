<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 600">
  <defs>
    <linearGradient id="patternGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#6d28d9;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="outputGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
    </linearGradient>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="3" stdDeviation="3" flood-opacity="0.15"/>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="900" height="600" fill="#f8fafc"/>

  <!-- Title -->
  <text x="450" y="35" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="22" font-weight="700" fill="#1e293b">Transform Stage: Pattern Matching</text>

  <!-- Input Parse Tree -->
  <rect x="30" y="80" width="260" height="200" rx="12" fill="#f1f5f9" stroke="#64748b" stroke-width="2" filter="url(#shadow)"/>
  <text x="160" y="105" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="14" font-weight="600" fill="#1e293b">Parse Tree (Input)</text>

  <!-- Tree structure -->
  <rect x="50" y="120" width="220" height="30" rx="4" fill="#e2e8f0"/>
  <text x="160" y="140" text-anchor="middle" font-family="JetBrains Mono, monospace" font-size="10" fill="#475569">{ int: "42" }</text>
  <rect x="50" y="160" width="220" height="30" rx="4" fill="#e2e8f0"/>
  <text x="160" y="180" text-anchor="middle" font-family="JetBrains Mono, monospace" font-size="10" fill="#475569">{ op: "+" }</text>
  <rect x="50" y="200" width="220" height="30" rx="4" fill="#e2e8f0"/>
  <text x="160" y="220" text-anchor="middle" font-family="JetBrains Mono, monospace" font-size="10" fill="#475569">{ rhs: { int: "8" } }</text>
  <text x="160" y="260" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#64748b">Generic structure</text>

  <!-- Arrow -->
  <path d="M 300 180 L 340 180" stroke="#8b5cf6" stroke-width="3" marker-end="url(#arrow)"/>

  <!-- Pattern Matching Section -->
  <rect x="360" y="80" width="200" height="200" rx="12" fill="#ede9fe" stroke="#8b5cf6" stroke-width="2" filter="url(#shadow)"/>
  <text x="460" y="105" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="14" font-weight="600" fill="#6d28d9">Pattern Rules</text>

  <!-- Rule 1 -->
  <text x="380" y="135" font-family="JetBrains Mono, monospace" font-size="9" fill="#475569">rule(int: simple(:n))</text>
  <rect x="380" y="145" width="160" height="40" rx="4" fill="#c4b5fd"/>
  <text x="460" y="165" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#faf5ff">Matches: { int: "42" }</text>
  <text x="460" y="180" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#faf5ff">Binds: n = "42"</text>

  <!-- Rule 2 -->
  <text x="380" y="205" font-family="JetBrains Mono, monospace" font-size="8" fill="#475569">rule(left: s(:l), op: s("+"),</text>
  <text x="380" y="218" font-family="JetBrains Mono, monospace" font-size="8" fill="#475569">     right: s(:r))</text>
  <rect x="380" y="225" width="160" height="40" rx="4" fill="#c4b5fd"/>
  <text x="460" y="245" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#faf5ff">Matches: AddExpr</text>
  <text x="460" y="258" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#faf5ff">Binds: l, op, r</text>

  <!-- Arrow -->
  <path d="M 570 180 L 610 180" stroke="#10b981" stroke-width="3" marker-end="url(#arrow)"/>

  <!-- Output Section -->
  <rect x="620" y="80" width="260" height="200" rx="12" fill="#d1fae5" stroke="#10b981" stroke-width="2" filter="url(#shadow)"/>
  <text x="750" y="105" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="14" font-weight="600" fill="#059669">Typed Output</text>

  <rect x="640" y="120" width="220" height="50" rx="8" fill="#a7f3d9"/>
  <text x="750" y="145" text-anchor="middle" font-family="JetBrains Mono, monospace" font-size="10" fill="#dcfce7">AddExpr(42, "+", 8)</text>
  <text x="750" y="160" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#d1fae5">Your domain type</text>

  <text x="750" y="195" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#64748b">Can be any type:</text>
  <text x="750" y="210" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#059669">• Custom struct/enum</text>
  <text x="750" y="225" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#059669">• Built-in types (i32, String)</text>
  <text x="750" y="240" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#059669">• Evaluated result</text>
  <text x="750" y="260" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#64748b">(Domain-specific)</text>

  <!-- Pattern Types Section -->
  <text x="450" y="320" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="16" font-weight="600" fill="#1e293b">Pattern Types</text>

  <!-- Simple pattern -->
  <rect x="30" y="350" width="200" height="100" rx="8" fill="#fef3c7" stroke="#f59e0b" stroke-width="2" filter="url(#shadow)"/>
  <text x="130" y="375" text-anchor="middle" font-family="JetBrains Mono, monospace" font-size="11" fill="#b45309">simple(:x)</text>
  <text x="130" y="400" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#9243c4">Matches: Leaf values</text>
  <text x="130" y="420" text-anchor="middle" font-family="JetBrains Mono, monospace" font-size="9" fill="#64748b">"42", "hello"</text>
  <text x="130" y="440" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#059669">Binds: x = value</text>

  <!-- Sequence pattern -->
  <rect x="250" y="350" width="200" height="100" rx="8" fill="#fef3c7" stroke="#f59e0b" stroke-width="2" filter="url(#shadow)"/>
  <text x="350" y="375" text-anchor="middle" font-family="JetBrains Mono, monospace" font-size="11" fill="#b45309">sequence(:x)</text>
  <text x="350" y="400" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#9243c4">Matches: Arrays</text>
  <text x="350" y="420" text-anchor="middle" font-family="JetBrains Mono, monospace" font-size="9" fill="#64748b">["a", "b", "c"]</text>
  <text x="350" y="440" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#059669">Binds: x = array</text>

  <!-- Subtree pattern -->
  <rect x="470" y="350" width="200" height="100" rx="8" fill="#fef3c7" stroke="#f59e0b" stroke-width="2" filter="url(#shadow)"/>
  <text x="570" y="375" text-anchor="middle" font-family="JetBrains Mono, monospace" font-size="11" fill="#b45309">subtree(:x)</text>
  <text x="570" y="400" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#9243c4">Matches: Anything</text>
  <text x="570" y="420" text-anchor="middle" font-family="JetBrains Mono, monospace" font-size="9" fill="#64748b">{...}, [...], "str"</text>
  <text x="570" y="440" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#059669">Binds: x = whole tree</text>

  <!-- Hash pattern -->
  <rect x="690" y="350" width="200" height="100" rx="8" fill="#fef3c7" stroke="#f59e0b" stroke-width="2" filter="url(#shadow)"/>
  <text x="790" y="375" text-anchor="middle" font-family="JetBrains Mono, monospace" font-size="10" fill="#b45309">{ key: pattern }</text>
  <text x="790" y="400" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#9243c4">Matches: Hashes</text>
  <text x="790" y="420" text-anchor="middle" font-family="JetBrains Mono, monospace" font-size="8" fill="#64748b">{int: simple(:n)}</text>
  <text x="790" y="440" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#059669">Matches by keys</text>

  <!-- Arrowheads -->
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#6d28d9"/>
    </marker>
  </defs>

  <!-- Key Insight -->
  <rect x="30" y="480" width="860" height="70" rx="8" fill="#ede9fe" stroke="#8b5cf6" stroke-width="2"/>
  <text x="50" y="510" font-family="Inter, system-ui, sans-serif" font-size="12" font-weight="600" fill="#6d28d9">Transform = Pattern + Action</text>
  <text x="50" y="530" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#475569">• Pattern: Describes the shape of the tree to match</text>
  <text x="300" y="530" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#475569">• Action: Creates your domain object from matched values</text>
  <text x="600" y="530" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#475569">• Rules are tried in order until one matches</text>
</svg>